<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Novelty - Answer Me</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <style>
        .hidden {
            display: none;
        }

    </style>
</head>
<body>
<section class="login-area">
    <input class="form-control enter-username" type="text" placeholder="Enter your username">
    <p class="help-text"></p>
    <button class="btn btn-primary login">Login</button>


</section>
<section class="lobby hidden">
    <!-- login success... waiting -->
    <p>Name: {{ session['username'] }}</p>
    <h1>Lobby</h1>
</section>
<section class="multiple-choice hidden">
    <h1>Multiple Choice section</h1>
    <h2 class="mcq"></h2>
    <button class="answer answer1"></button>
    <button class="answer answer2"></button>
    <button class="answer answer3"></button>
    <button class="answer answer4"></button>
</section>
<section class="queue-up hidden">
    <h1>Queue up page</h1>
    <button class="click-me">click me to queue</button>
</section>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
    $(document).ready(function () {
        // try logging in with localStorage first
        if (localStorage.getItem("username")) {
            loginWith(localStorage.getItem("username"));
        }

        // when the login button is pressed
        $('.login-area .login').click(function () {
            // login to get the session cookie
            var username = $(".enter-username").val();
            loginWith(username);
        });
    });


    /**
     * Connect to the main game via socket. Actively listen to connections and change the visibility of the sections
     * if required.
     */
    function connectToGame() {
        var socket = io.connect('http://' + document.domain + ':' + location.port + '/game');

        // click the button to emit
        $('.click-me').click(function () {
           socket.emit('clicked_button');
        });

        // the multiple choice answer buttons have been pressed
        $(".multiple-choice .answer").click(function () {
            if
            // disable everything
            $(".multiple-choice .answer").attr("disabled", "disabled");

            // obtain what has been clicked
            var $btn = $(this);
            var clicked_option = -1;
            if ($btn.hasClass("answer1")) {
                clicked_option = 1;
            } else if ($btn.hasClass("answer2")) {
                clicked_option = 2;
            } else if ($btn.hasClass("answer3")) {
                clicked_option = 3;
            } else if ($btn.hasClass("answer4")) {
                clicked_option = 4;
            }
            // emit the "correct answer"
            socket.emit('answer_option', {"answer_number": clicked_option})

        });

        socket.on('multiple_choice', function(data) {
            $(".multiple-choice .mcq").text(data['question']);
            $(".multiple-choice .answer1").text(data['answers'][0]);
            $(".multiple-choice .answer2").text(data['answers'][1]);
            $(".multiple-choice .answer3").text(data['answers'][2]);
            $(".multiple-choice .answer4").text(data['answers'][3]);
            switchView("multiple-choice");
        });

        socket.on('lobby', function() {
            switchView("lobby");
        });

        socket.on('logout_everyone', function() {
            switchView("login-area");
            logout();
        });

        socket.on('queue_up', function() {
            switchView("queue-up");
        });
    }

    function switchView(viewName) {
        $("section").addClass("hidden");
        if (viewName === "lobby") {
            $("section.lobby").removeClass("hidden");
        } else if (viewName === "login-area") {
            $("section.login-area").removeClass("hidden");
        } else if (viewName === "multiple-choice") {
            $("section.multiple-choice").removeClass("hidden");
        } else if (viewName === "queue-up") {
            $("section.queue-up").removeClass("hidden");
        }
    }

    function loginWith(username) {
        $.post("{{ url_for('login') }}", {"username": username}, function (data) {
            if (data['success']) {
                $(".login-area .help-text").text("");
                $(".login-area").addClass("hidden");
                $(".lobby").removeClass("hidden");
                localStorage.setItem("username", data["username"]);
                connectToGame();
            } else {
                $(".login-area .help-text").text("username not registered. Please use the prefix of your utoronto email");
            }
        });
    }

    function logout() {
        $.post("{{ url_for('logout') }}");
        localStorage.clear();
        location.reload();
    }

</script>
</html>