<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Novelty - Answer Me</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <style>
        .hidden {
            display: none;
        }

        .help-text {
            color: red;
        }

        section.multiple-choice button {
            font-size: 5em;
            display: block;
            width: 100%;
            margin-bottom: 20px;
        }

        section.login-area {
            margin-left: 24em;
            bottom: 250px;
            position: absolute;
        }

        .login {
            margin-left: 4em;
        }

        .enter-username {
            background-color: #3a61a2;
        }

        .enter-nickname {
            background-color: #3a61a2;
        }

        .background {
            background-size: cover;
            background-repeat: no-repeat;
        }

        .lobby-bg {
            background-image: url({{url_for('static',filename='images/login.png')}})
        }

        .login-bg {
            background-image: url({{url_for('static',filename='images/lobby.png')}})
        }

        .multiple-choice-bg {
            background-image: url({{url_for('static',filename='images/login.png')}})
        }


    </style>
</head>
<body class="background login-bg">
<section class="login-area">
    <input class="form-control enter-username" type="text" placeholder="Enter your username">
    <input class="form-control enter-nickname" type="text" placeholder="Preferred nickname">
    <p class="help-text"></p>
    <button class="btn btn-primary login">Login</button>
</section>

<h2 class="nickname"></h2>

<section class="lobby hidden">
    <!-- login success... waiting -->
    <h1>Lobby</h1>
    <p class="first"></p>
    <p class="second"></p>
    <p class="third"></p>

</section>
<section class="multiple-choice hidden">
    <h1>Multiple Choice section</h1>
    <h2 class="mcq"></h2>
    <button class="btn btn-primary answer answer1"></button>
    <button class="btn btn-primary answer answer2"></button>
    <button class="btn btn-primary answer answer3"></button>
    <button class="btn btn-primary answer answer4"></button>
</section>
<section class="queue-up hidden">
    <h1>Queue up page</h1>
    <button class="click-me">click me to queue</button>
</section>

<section class="quick hidden">
    <h1>Quick Reaction</h1>
    <button class="quickbutton">click me</button>
</section>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
    $(document).ready(function () {

        setTimeout(
            function print() {
                console.log("DONE")
            },
            2000
        )

        // try logging in with localStorage first
        if (localStorage.getItem("username")) {
            loginWith(localStorage.getItem("username"));
        }

        // when the login button is pressed
        $('.login-area .login').click(function () {
            // login to get the session cookie
            var username = $(".enter-username").val();
            var nickname = $(".enter-nickname").val() || null;
            loginWith(username, nickname);
        });
    });


    /**
     * Connect to the main game via socket. Actively listen to connections and change the visibility of the sections
     * if required.
     */
    function connectToGame() {
        var socket = io.connect('http://' + document.domain + ':' + location.port + '/game');

        // click the button to emit
        $('.click-me').click(function () {
           socket.emit('clicked_button');
        });

        // the multiple choice answer buttons have been pressed
        $(".multiple-choice .answer").click(function () {
            var $btn = $(this);

            // add border
            $btn.css("border", "1em solid red");

            if ($(this).attr("disabled") === "disabled") {
                return false;
            }
            // disable everything
            $(".multiple-choice .answer").attr("disabled", "disabled");

            // obtain what has been clicked
            var clicked_option = -1;
            if ($btn.hasClass("answer1")) {
                clicked_option = 1;
            } else if ($btn.hasClass("answer2")) {
                clicked_option = 2;
            } else if ($btn.hasClass("answer3")) {
                clicked_option = 3;
            } else if ($btn.hasClass("answer4")) {
                clicked_option = 4;
            }
            // emit the "correct answer"
            socket.emit('answer_option', {"answer_number": clicked_option})

        });

        socket.on("quick", function(data){
            $(".quickbutton").attr("disabled", false);
        })


        $(".quickbutton").click(function(){
            var name = $(".nickname").text()
            $(this).attr("disabled", true);
            socket.emit("quick_next", name);
        })

        socket.on('multiple_choice', function(data) {
            if(data === false){
                switchView("quick")
            }
            else{
                $(".multiple-choice .mcq").text(data['question']);
                $(".multiple-choice .answer").attr("disabled", null);
                $(".multiple-choice .answer").css("border", "");

                $(".multiple-choice .answer1").text(data['answers'][0]);
                $(".multiple-choice .answer2").text(data['answers'][1]);
                $(".multiple-choice .answer3").text(data['answers'][2]);
                $(".multiple-choice .answer4").text(data['answers'][3]);
                switchView("multiple-choice");
            }
        });

        socket.on('lobby', function(data) {
            switchView("lobby");
        });

        socket.on('logout_everyone', function() {
            switchView("login-area");
            logout();
        });

        socket.on('queue_up', function() {
            switchView("queue-up");
        });
    }

    function switchView(viewName) {
        $("section").addClass("hidden");
        if (viewName === "lobby") {
            $("section.lobby").removeClass("hidden");
        } else if (viewName === "login-area") {
            $("section.login-area").removeClass("hidden");
        } else if (viewName === "multiple-choice") {
            $("section.multiple-choice").removeClass("hidden");
        } else if (viewName === "queue-up") {
            $("section.queue-up").removeClass("hidden");
        } else if (viewName === "quick"){
            $("section.quick").removeClass("hidden")
        }
    }

    function loginWith(username, nickname=null) {
        $.post("{{ url_for('login') }}", {"username": username, "nickname": nickname}, function (data) {
            if (data['success']) {
                $(".login-area .help-text").text("");
                $(".login-area").addClass("hidden");
                $(".lobby").removeClass("hidden");
                $(".nickname").text(nickname)
                localStorage.setItem("username", data["username"]);
                connectToGame();
            } else {
                var message = data["message"];
                $(".login-area .help-text").text(message);
            }
        });
    }

    function logout() {
        $.post("{{ url_for('logout') }}");
        localStorage.clear();
        location.reload();
    }

</script>
</html>
